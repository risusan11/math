<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>グラフ＆計算チャレンジ統合システム</title>
<style>
  body {
    font-family: 'Meiryo', sans-serif;
    background-color: #f5f7fa;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    margin: 0;
  }
  h1 {
    margin-top: 20px;
  }
  .menu, .graph-mode, .calc-mode, .records-mode {
    display: none;
    text-align: center;
    width: 90%;
    max-width: 900px;
  }
  button {
    margin: 8px;
    padding: 10px 16px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 6px;
    border: none;
    background-color: #0074D9;
    color: white;
  }
  button:hover {
    background-color: #005fa3;
  }
  input {
    font-size: 16px;
    padding: 6px 10px;
    margin: 5px;
  }
  .graph-container {
    position: relative;
    width: 800px;
    height: 500px;
    background-color: white;
    border: 2px solid #333;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    margin: 10px auto;
    overflow: hidden;
  }
  #ruler {
    position: absolute;
    width: 600px;
    height: 4px;
    background: rgba(128,128,128,0.3);
    border: 1px solid #555;
    top: 250px;
    left: 100px;
    transform-origin: center center;
    cursor: move;
    display: none;
  }
  #ruler-handle {
    position: absolute;
    right: -10px;
    top: -6px;
    width: 12px;
    height: 12px;
    background: #555;
    border-radius: 50%;
    cursor: grab;
  }
  table {
    border-collapse: collapse;
    width: 100%;
  }
  th, td {
    border: 1px solid #999;
    padding: 4px 8px;
  }
  th { background: #e0e0e0; }
  #score { font-weight: bold; margin: 8px; }
</style>
</head>
<body>

<h1>グラフ＆計算チャレンジ統合システム</h1>
<div class="menu" id="menu">
  <button onclick="switchMode('graph')">グラフ練習モード</button>
  <button onclick="switchMode('calc')">計算チャレンジモード</button>
  <button onclick="switchMode('records')">記録を見る</button>
</div>

<!-- グラフモード -->
<div class="graph-mode" id="graph-mode">
  <h2>グラフ練習モード</h2>
  <input id="equation" type="text" placeholder="例：y = x^2 + 2x - 3, (x-2)^2 + (y+1)^2 = 9" />
  <div>
    <button id="drawBtn">式からグラフを描く</button>
    <button id="quizBtn">問題を出す</button>
    <button id="gradeBtn">採点する</button>
    <button id="rulerBtn">定規モード</button>
    <button id="rulerDrawBtn">線を引く</button>
    <button id="freeBtn">手書きモード</button>
    <button onclick="switchMode('menu')">メニューに戻る</button>
  </div>
  <div class="graph-container">
    <canvas id="graphCanvas" width="800" height="500"></canvas>
    <div id="ruler"><div id="ruler-handle"></div></div>
  </div>
  <div id="question"></div>
  <div id="score"></div>
</div>

<!-- 計算モード -->
<div class="calc-mode" id="calc-mode">
  <h2>計算チャレンジモード</h2>
  <div id="calc-area">
    <button onclick="startChallenge()">チャレンジ開始</button>
  </div>
  <div id="calc-question"></div>
  <input id="calc-answer" type="text" placeholder="答えを入力" style="display:none;">
  <div id="calc-result"></div>
  <button id="backToMenuBtn" style="display:none;" onclick="switchMode('menu')">メニューに戻る</button>
</div>

<!-- 記録モード -->
<div class="records-mode" id="records-mode">
  <h2>記録一覧</h2>
  <div id="recordTable"></div>
  <button onclick="clearRecords()">全削除</button>
  <button onclick="switchMode('menu')">メニューに戻る</button>
</div>

<script>
let currentMode = 'menu';
function switchMode(mode){
  document.getElementById('menu').style.display = 'none';
  document.getElementById('graph-mode').style.display = 'none';
  document.getElementById('calc-mode').style.display = 'none';
  document.getElementById('records-mode').style.display = 'none';
  if(mode==='graph')document.getElementById('graph-mode').style.display='block';
  else if(mode==='calc')document.getElementById('calc-mode').style.display='block';
  else if(mode==='records'){showRecords();document.getElementById('records-mode').style.display='block';}
  else document.getElementById('menu').style.display='block';
  currentMode=mode;
}
switchMode('menu');

// ===== グラフモード =====
const canvas=document.getElementById('graphCanvas');
const ctx=canvas.getContext('2d');
const ruler=document.getElementById('ruler');
const handle=document.getElementById('ruler-handle');
const scale=20;
const originX=Math.floor(canvas.width/2/scale)*scale+0.5;
const originY=Math.floor(canvas.height/2/scale)*scale+0.5;
let paths=[],currentPath=[],drawing=false,mode='draw',angle=0,isGrading=false,currentEquation='',tolerance=10;

function parseFraction(str){
  if(str===undefined||str===null||str==='')return 0;
  str=String(str);
  if(str.includes('/')){const[n,d]=str.split('/').map(Number);return n/d;}
  return parseFloat(str);
}
function drawGrid(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='#ddd';ctx.lineWidth=1;
  for(let x=0.5;x<=canvas.width;x+=scale){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();}
  for(let y=0.5;y<=canvas.height;y+=scale){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}
  ctx.strokeStyle='#000';ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(0,originY);ctx.lineTo(canvas.width,originY);ctx.stroke();
  ctx.beginPath();ctx.moveTo(originX,0);ctx.lineTo(originX,canvas.height);ctx.stroke();
}
function parseEquation(eq){
  const c=eq.replace(/\s+/g,'').replace('²','^2');
  let a=0,b=0,cst=0;
  const circle=c.match(/^\(x([+-]?[0-9./]*)\)\^2\+\(y([+-]?[0-9./]*)\)\^2=([0-9./^]+)$/i);
  if(circle){
    const cx=-parseFraction(circle[1]);
    const cy=-parseFraction(circle[2]);
    let r=0;let expr=circle[3];
    if(expr.includes('^')){const[base,power]=expr.split('^').map(Number);r=Math.pow(base,power);}
    else r=parseFraction(expr);
    return{type:'circle',a:cx,b:cy,r:Math.sqrt(r)};
  }
  const quad=c.match(/^y=([+-]?[0-9./]*)x\^2([+-]?[0-9./]*)x?([+-]?[0-9./]*)?$/i);
  if(quad){a=parseFraction(quad[1]||1);b=parseFraction(quad[2]||0);cst=parseFraction(quad[3]||0);return{type:'quadratic',a,b,c:cst};}
  const lin=c.match(/^y=([+-]?[0-9./]*x)?([+-]?[0-9./]*)?$/i);
  if(lin){if(lin[1]){const coef=lin[1].replace('x','');if(coef===''||coef==='+')a=1;else if(coef==='-')a=-1;else a=parseFraction(coef);}if(!lin[1]&&lin[2]){a=0;b=parseFraction(lin[2]);}else if(lin[2])b=parseFraction(lin[2]);return{type:'linear',a,b};}
  const constMatch=c.match(/^y=([+-]?[0-9./^]+)$/i);
  if(constMatch){let expr=constMatch[1];if(expr.includes('^')){const[base,power]=expr.split('^').map(Number);return{type:'constant',value:Math.pow(base,power)};}return{type:'constant',value:parseFraction(expr)};}
  return null;
}
function drawFunction(eq,color='#0074D9'){
  const r=parseEquation(eq);if(!r)return;
  ctx.strokeStyle=color;ctx.lineWidth=2;ctx.beginPath();let started=false;
  if(r.type==='circle'){ctx.beginPath();ctx.arc(originX+r.a*scale,originY-r.b*scale,r.r*scale,0,Math.PI*2);ctx.stroke();return;}
  if(r.type==='constant'){const y=r.value;const Y=originY-y*scale;ctx.moveTo(0,Y);ctx.lineTo(canvas.width,Y);}
  else{for(let x=-40;x<=40;x+=0.1){let y=r.type==='quadratic'?r.a*x*x+r.b*x+r.c:r.a*x+r.b;const X=originX+x*scale;const Y=originY-y*scale;if(!started){ctx.moveTo(X,Y);started=true;}else ctx.lineTo(X,Y);}}
  ctx.stroke();
}
canvas.addEventListener('mousedown',e=>{if(isGrading||mode!=='draw')return;drawing=true;currentPath=[];ctx.strokeStyle='#e74c3c';ctx.lineWidth=2;ctx.beginPath();drawPoint(e);});
canvas.addEventListener('mouseup',()=>{if(mode==='draw'&&drawing)paths.push(currentPath);drawing=false;});
canvas.addEventListener('mousemove',drawPoint);
function drawPoint(e){if(!drawing||mode!=='draw')return;const rect=canvas.getBoundingClientRect();const x=e.clientX-rect.left;const y=e.clientY-rect.top;currentPath.push({x,y});ctx.lineTo(x,y);ctx.stroke();}
function gradeDrawing(eq){
  isGrading=true;const r=parseEquation(eq);const correctPoints=[];
  for(let x=-40;x<=40;x+=0.5){let y;
    if(r.type==='quadratic')y=r.a*x*x+r.b*x+r.c;
    else if(r.type==='linear')y=r.a*x+r.b;
    else if(r.type==='constant')y=r.value;
    else continue;
    correctPoints.push({X:originX+x*scale,Y:originY-y*scale});
  }
  let match=0,total=0;
  for(const path of paths){for(const p of path){total++;for(const c of correctPoints){const d=Math.sqrt((p.x-c.X)**2+(p.y-c.Y)**2);if(d<=tolerance){match++;break;}}}}
  const score=total===0?0:Math.round((match/total)*100);
  let mark='▲';if(score>=90)mark='〇';else if(score<30)mark='×';
  document.getElementById('score').innerHTML=`正答率: ${score}%　判定: ${mark}`;
  drawFunction(eq,'#00cc66');
  setTimeout(()=>{isGrading=false;},500);
}
document.getElementById('drawBtn').onclick=()=>{mode='draw';ruler.style.display='none';drawGrid();drawFunction(document.getElementById('equation').value);paths=[];};
document.getElementById('quizBtn').onclick=()=>{
  const type=Math.random()<0.25?'circle':Math.random()<0.5?'linear':'quadratic';
  if(type==='circle'){
    const a=(Math.floor(Math.random()*5)-2);
    const b=(Math.floor(Math.random()*5)-2);
    const r=(Math.floor(Math.random()*4)+1);
    currentEquation=`(x${a>=0?'-':''}${Math.abs(a)})^2+(y${b>=0?'-':''}${Math.abs(b)})^2=${r}^2`;
  }else if(type==='linear'){
    const a=(Math.floor(Math.random()*9)-4);
    const b=(Math.floor(Math.random()*9)-4);
    currentEquation=`y=${a===0?'':a+'x'}${b>=0?'+':''}${b}`;
  }else{
    const a=(Math.random()*0.5+0.5).toFixed(1)*(Math.random()<0.5?-1:1);
    const b=(Math.floor(Math.random()*5)-2);
    const c=(Math.floor(Math.random()*5)-2);
    currentEquation=`y=${a}x^2${b>=0?'+':''}${b}x${c>=0?'+':''}${c}`;
  }
  document.getElementById('question').textContent=`問題: ${currentEquation} のグラフをかけ`;
  drawGrid();paths=[];
};
document.getElementById('gradeBtn').onclick=()=>{if(!currentEquation){alert('まず問題を出してね！');return;}gradeDrawing(currentEquation);};
document.getElementById('rulerBtn').onclick=()=>{mode='ruler';ruler.style.display='block';};
document.getElementById('freeBtn').onclick=()=>{mode='draw';ruler.style.display='none';};
document.getElementById('rulerDrawBtn').onclick=()=>{
  if(ruler.style.display==='none')return;
  const rect=ruler.getBoundingClientRect();const canvasRect=canvas.getBoundingClientRect();
  const cx=rect.left+rect.width/2-canvasRect.left;const cy=rect.top+rect.height/2-canvasRect.top;
  const rad=angle*Math.PI/180;const length=2000;
  const x1=cx-Math.cos(rad)*length;const y1=cy-Math.sin(rad)*length;
  const x2=cx+Math.cos(rad)*length;const y2=cy+Math.sin(rad)*length;
  ctx.strokeStyle='#0099ff';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();
  paths.push([{x:x1,y:y1},{x:x2,y:y2}]);
};
drawGrid();

// ===== 計算モード =====
let problems=[],currentIndex=0,correctCount=0,wrongCount=0,startTime=0;
function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function generateProblem(i){
  if(i<5)return `${randomInt(1,9)}+${randomInt(1,9)}`;
  if(i<10)return `${randomInt(2,9)}-${randomInt(1,9)}`;
  if(i<15)return `${randomInt(2,9)}×${randomInt(2,9)}`;
  if(i<20)return `${randomInt(10,99)}÷${[2,3,4,5,6,7,8,9][randomInt(0,7)]}`;
  if(i<25)return `${randomInt(-9,9)}+${randomInt(-9,9)}`;
  return `${(Math.random()*10).toFixed(1)}+${(Math.random()*10).toFixed(1)}`;
}
function startChallenge(){
  problems=[];for(let i=0;i<30;i++)problems.push(generateProblem(i));
  currentIndex=0;correctCount=0;wrongCount=0;document.getElementById('calc-result').textContent='';
  document.getElementById('calc-area').style.display='none';
  document.getElementById('calc-answer').style.display='inline';
  document.getElementById('backToMenuBtn').style.display='none';
  startTime=Date.now();
  showProblem();
}
function showProblem(){
  if(currentIndex>=problems.length){endChallenge();return;}
  document.getElementById('calc-question').textContent=`第${currentIndex+1}問：${problems[currentIndex]} = ?`;
  document.getElementById('calc-answer').value='';document.getElementById('calc-answer').focus();
}
document.getElementById('calc-answer').addEventListener('keydown',e=>{
  if(e.key==='Enter'){checkAnswer();}
});
function checkAnswer(){
  const userAns=parseFloat(document.getElementById('calc-answer').value);
  const p=problems[currentIndex].replace('×','*').replace('÷','/');
  const correctVal=eval(p);
  if(Math.abs(userAns-correctVal)<0.001)correctCount++;else wrongCount++;
  currentIndex++;showProblem();
}
function endChallenge(){
  const time=(Date.now()-startTime)/1000;
  const avg=(time/30).toFixed(2);
  let rank='E';
  if(correctCount===30 && time<=45)rank='SSS';
  else if(correctCount===30 && time<=60)rank='SS';
  else if(correctCount===30 && time<=90)rank='S';
  else if(correctCount>=29 && time<=120)rank='A';
  else if(correctCount>=27 && time<=150)rank='B';
  else if(correctCount>=24 && time<=200)rank='C';
  else if(correctCount>=20 && time<=250)rank='D';

  const result=`${correctCount}問正解 / ${wrongCount}問ミス<br>
  経過時間: ${time.toFixed(1)}秒<br>
  平均: ${avg}秒/問<br>
  ランク: ${rank}`;

  document.getElementById('calc-result').innerHTML=result;
  document.getElementById('calc-answer').style.display='none';
  document.getElementById('backToMenuBtn').style.display='inline';
  saveRecord({date:new Date().toLocaleString(),correct:correctCount,wrong:wrongCount,time:time.toFixed(1),avg,rank});
  document.getElementById('calc-question').textContent='終了！';
}

function saveRecord(r){
  let records=JSON.parse(localStorage.getItem('calcRecords')||'[]');
  records.push(r);
  if(records.length>1000)records=records.slice(-1000);
  localStorage.setItem('calcRecords',JSON.stringify(records));
}

function showRecords(){
  const records=JSON.parse(localStorage.getItem('calcRecords')||'[]');
  let html='<table><tr><th>日付</th><th>正答</th><th>ミス</th><th>時間(s)</th><th>平均(s)</th><th>ランク</th></tr>';
  for(let i=records.length-1;i>=Math.max(0,records.length-100);i--){
    const r=records[i];
    html+=`<tr><td>${r.date}</td><td>${r.correct}</td><td>${r.wrong}</td><td>${r.time}</td><td>${r.avg}</td><td>${r.rank}</td></tr>`;
  }
  html+='</table>';
  document.getElementById('recordTable').innerHTML=html;
}

function clearRecords(){
  if(confirm('本当に全て削除しますか？'))localStorage.removeItem('calcRecords');
  showRecords();
}
</script>
</body>
</html>
